// Ï†ÑÏó≠Î≥ÄÏàò ÏÑ§Ï†ï
const BASE_URL = "http://www.melloplace.com:8080";
// const BASE_URL = "http://localhost:8080";
// ÏàòÏ†ïÏö© input:hidden
const editIdEl = document.getElementById("editId");

let currentPage = 0;
const pageSize = 5;


function submitData() {
    const name = document.getElementById("name").value;
    const age = document.getElementById("age").value;

    fetch("http://localhost:8080/user", {
        method : "POST",
        headers : {
        "Content-Type" : "application/json"
        },
        body : JSON.stringify({name, age}),
    })
    .then(res => res.text())
    .then(text => {
        document.getElementById("result").innerText = text + "Í±¥Ìù¨";
    })
    .catch(err => {
        document.getElementById("result").innerText = "ÏÑúÎ≤Ñ Ïò§Î•ò" + err.message;
    });
}


function start() {
    document.querySelectorAll('.content-box').forEach(el => {
        el.classList.toggle('active');
    })
}

function openLayerPopup(e) {
    document.querySelector('.' + e).style.display = 'flex';
    document.querySelector('.' + e).dataset.mode = "create";
    document.getElementById('actionType').textContent = "Îì±Î°ù";
    document.getElementById('actionBtn').textContent = "Îì±Î°ù";
    editIdEl.value = '';
}

function closeLayerPopup(e) {
    const popup = document.querySelector('.' + e);
    
    if(!popup) {
        return;
    }

    popup.style.display = 'none';

    const firstRadio = popup.querySelector('.checkbox-area .common-radio:first-child');

    if(firstRadio) {
        firstRadio.checked = true;
    }

    const textarea = popup.querySelector('textarea')

    if(textarea) {
        textarea.value = '';
    }

    editIdEl.value = '';

}

function addList(typeData, textData, id, createdAt) {
    const resultListArea = document.querySelector('.result-list-area');

    const defaultList = resultListArea.querySelector('.default');

    if(defaultList) {
        defaultList.parentElement.remove();
    }

    const newList = document.createElement('div');
    newList.classList.add('result-list');

    const tagClass = typeData === "Í≥µÏßÄ" ? "tag notice" : "tag";

    newList.innerHTML = `<div class="checkbox-area"><input type="checkbox" id="check_${id}" value="${id}" class="common-checkbox"><label for="check_${id}"></label></div><div class="content-area" onclick="openEditPopup(${id}, 'enroll')"><span class="${tagClass}">${typeData}</span><p class="content">${textData}</p><span class="author">ÏûëÏÑ±Ïùº<span class="created-date">${formatRelativeTime(createdAt)}</span></span></div>`;

    resultListArea.prepend(newList);

    console.log(createdAt);

}

function submitContent() {
    const popup = document.querySelector('.layer-popup-content');

    const type = popup.querySelector('.common-radio:checked').value;
    const text = popup.querySelector('textarea').value;
    const id = editIdEl.value;

    const data = {
        typeData : type,
        textData : text
    }

    // ÏöîÏ≤≠ Î©îÏÑúÎìúÏùò URL Î∂ÑÍ∏∞ Ï≤òÎ¶¨
    const method = id ? "PUT" : "POST";
    const url = id ? `http://www.melloplace.com:8080/crudTest/${id}` : "http://www.melloplace.com:8080/crudTest";
    // const url = id ? `http://localhost:8080/crudTest/${id}` : "http://localhost:8080/crudTest";


    fetch(url, {
        method : method,
        headers : {
            "Content-Type" : "application/json"
        },
        body : JSON.stringify(data)
    })
    .then(res => {
        if (!res.ok) throw new Error("ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò");
        return res.json();
    })
    .then(result => {
        closeLayerPopup('enroll');
        loadPage(0);    
        // addList(data.typeData, data.textData);

        if(id) {
            const existingItem = document.querySelector(`#check_${id}`).closest('.result-list');
            existingItem.querySelector('.tag').textContent = result.typeData;
            existingItem.querySelector('.tag').className = result.typeData === "Í≥µÏßÄ" ? "tag notice" : "tag";
            existingItem.querySelector('.content').textContent = result.textData;
        } else {
            addList(data.typeData, data.textData, result.id, result.createdAt);
        }
    })
    .catch(err => {
        console.error("Îì±Î°ù/ÏàòÏ†ï Ïã§Ìå®", err);
        alert("ÏÑúÎ≤Ñ Ïò§Î•òÎ°ú Îì±Î°ù/Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    });
}

window.addEventListener("DOMContentLoaded", () => {

    // fetch("http://localhost:8080/crudTest")
    fetch("http://www.melloplace.com:8080/crudTest")
    .then(res => res.json())
    .then(dataList => {
        const resultListArea = document.querySelector('.result-list-area');

        resultListArea.innerHTML = "";

        dataList.forEach(item => {
            addList(item.typeData, item.textData, item.id, item.createdAt);
        });
    })
    .catch(err => {
        console.error("Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®", err);
    })

    loadPage(0);
})

function deleteResultList() {

    const checkedResultList = document.querySelectorAll(".result-list input[type='checkbox']:checked");

    checkedResultList.forEach(checkbox => {
        const item = checkbox.closest('.result-list');
        const id = checkbox.value;

        if(item && id) {
            // fetch(`http://localhost:8080/crudTest/${id}`, {
            fetch(`http://www.melloplace.com:8080/crudTest/${id}`, {
                method : "DELETE"
            })
            .then(res => {
                if(res.status === 204) {
                    console.log(`id = ${id} ÏÇ≠Ï†ú ÏôÑÎ£å`);
                    item.remove();
                } else if (res.status === 404) {
                    alert("Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Ìï≠Î™©ÏûÖÎãàÎã§.");
                } else {
                    throw new Error("ÏÑúÎ≤Ñ Ïò§Î•ò");
                }
            })
            .catch(err => {
                console.error(`id=${id} DB ÏÇ≠Ï†ú Ïã§Ìå®`, err);
                alert("ÏÑúÎ≤Ñ Ïò§Î•òÎ°ú ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            })
        }
    })

    closeLayerConfirmPopup();
    loadPage(currentPage);  
}

function closeLayerConfirmPopup() {
    const popup = document.querySelector('.confirm');

    popup.style.display = 'none';
}


// Í≤ÄÏÉâÍ∏∞Îä•

function searchContent(event) {

    event.preventDefault();

    const field = document.getElementById("fieldSelect").value;
    const keyword = document.getElementById("keywordInput").value.trim();

    // Ï∂îÌõÑ Ï†ÑÏ≤¥ Í≤ÄÏÉâÏúºÎ°ú Î≥ÄÍ≤ΩÌï† ÏòàÏ†ï
    if(!keyword) {
        alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
        return;
    }

    fetch(`${BASE_URL}/crudTest/search?field=${field}&keyword=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(dataList => {
        const area = document.querySelector('.result-list-area');

        area.innerHTML = "";

        if(dataList.length === 0) {
            area.innerHTML = "<div class='result-list default'>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>"
            return;
        }

        dataList.forEach(item => addList(item.typeData, item.textData, item.id, item.createdAt));
    })
    .catch(err => {
        console.error("Í≤ÄÏÉâ Ïã§Ìå®", err);
        alert("ÏÑúÎ≤Ñ Ïò§Î•òÎ°ú Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    });

}


async function openEditPopup(id, e) {
    const data = await fetch(`${BASE_URL}/crudTest/${id}`).then(r => r.json());
    
    document.querySelector('.' + e).style.display = 'flex';
    document.querySelector('.' + e).dataset.mode = "edit";
    document.getElementById('actionType').textContent = "ÏàòÏ†ï";
    document.getElementById('actionBtn').textContent = "Ï†ÄÏû•";

    editIdEl.value = id;

    document.querySelectorAll('.common-radio').forEach( r => {
        r.checked = (r.value === data.typeData);
    });

    const popupRoot = document.querySelector('.' + e)

    console.log(data);
    popupRoot.querySelector('textarea').value = data.textData;

    
}


function formatRelativeTime(dateStr) {
    const d = new Date(dateStr);
    const diffSec = Math.floor((Date.now() - d.getTime()) / 1000);
    if (isNaN(diffSec) || diffSec < 0) return '';         // ÏûòÎ™ªÎêú ÏûÖÎ†• Ï≤òÎ¶¨

    if (diffSec < 60)               return 'Î∞©Í∏à Ï†Ñ';
    const diffMin = Math.floor(diffSec / 60);
    if (diffMin < 60)               return `${diffMin}Î∂Ñ Ï†Ñ`;
    const diffHr  = Math.floor(diffMin / 60);
    if (diffHr < 24)                return `${diffHr}ÏãúÍ∞Ñ Ï†Ñ`;
    const diffDay = Math.floor(diffHr / 24);
    if (diffDay < 30)               return `${diffDay}Ïùº Ï†Ñ`;
    const diffMon = Math.floor(diffDay / 30);
    if (diffMon < 12)               return `${diffMon}Îã¨ Ï†Ñ`;
    const diffYr  = Math.floor(diffMon / 12);
    return `${diffYr}ÎÖÑ Ï†Ñ`;
}

function drawPagination(totalPages, currentPage) {
    const paginationUl = document.querySelector('.pagination ul');
    paginationUl.innerHTML = ""; // Í∏∞Ï°¥ ÎÇ¥Ïö© Ï¥àÍ∏∞Ìôî

    // Ïù¥Ï†Ñ Î≤ÑÌäº
    const prevLi = document.createElement('li');
    prevLi.textContent = 'Ïù¥Ï†Ñ';
    prevLi.classList.toggle('disabled', currentPage === 0);
    prevLi.addEventListener('click', () => {
        if (currentPage > 0) loadPage(currentPage - 1);
    });
    paginationUl.appendChild(prevLi);

    // ÌéòÏù¥ÏßÄ Î≤àÌò∏ Î≤ÑÌäºÎì§
    for (let i = 0; i < totalPages; i++) {
        const li = document.createElement('li');
        li.textContent = i + 1;
        if (i === currentPage) li.classList.add('present');
        li.addEventListener('click', () => {
            loadPage(i);
        });
        paginationUl.appendChild(li);
    }

    // Îã§Ïùå Î≤ÑÌäº
    const nextLi = document.createElement('li');
    nextLi.textContent = 'Îã§Ïùå';
    nextLi.classList.toggle('disabled', currentPage === totalPages - 1);
    nextLi.addEventListener('click', () => {
        if (currentPage < totalPages - 1) loadPage(currentPage + 1);
    });
    paginationUl.appendChild(nextLi);
}


// üîñ¬†Ï∂îÍ∞Ä: ÌéòÏù¥ÏßÄÎ≥Ñ Î°úÎî©
function loadPage(page) {

  currentPage = page;

  fetch(`${BASE_URL}/crudTest/paged?page=${page}&size=${pageSize}`)
    .then(res => {
        if (!res.ok) {                    // ‚òÖ ÏÉÅÌÉú ÏΩîÎìú ÌôïÏù∏
            return res.text().then(t => {   // 4xx/5xxÎ©¥ Î≥∏Î¨∏ÎèÑ Í∞ôÏù¥ Î≥¥Í∏∞
            throw new Error(`HTTP ${res.status}\n${t}`);
        });
      }
      return res.json();  
    })
    .then(data => {
      const area = document.querySelector('.result-list-area');
      area.innerHTML = "";
      data.content.forEach(item =>
        addList(item.typeData, item.textData, item.id, item.createdAt)
      );
      drawPagination(data.totalPages, currentPage);
    })
    .catch(err => {
        console.error("ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®", err);
    });
}
